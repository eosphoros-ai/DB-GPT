"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4931],{32027:function(e,l,i){i.r(l),i.d(l,{default:function(){return D}});var a=i(85893),t=i(67294),n=i(577),d=i(45396),o=i(83062),s=i(51009),r=i(71577),u=i(79531),c=i(57346),v=i(16165),h=i(99513),x=i(30119),m=i(39332),f=i(67772),p=i(39156),g=i(6171),w=i(18073),y=i(14313),j=i(87462),b={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M893.3 293.3L730.7 130.7c-12-12-28.3-18.7-45.3-18.7H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V338.5c0-17-6.7-33.2-18.7-45.2zM384 176h256v112H384V176zm128 554c-79.5 0-144-64.5-144-144s64.5-144 144-144 144 64.5 144 144-64.5 144-144 144zm0-224c-44.2 0-80 35.8-80 80s35.8 80 80 80 80-35.8 80-80-35.8-80-80-80z"}}]},name:"save",theme:"filled"},_=i(84089),k=t.forwardRef(function(e,l){return t.createElement(_.Z,(0,j.Z)({},e,{ref:l,icon:b}))});function N(){return(0,a.jsxs)("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"49817",width:"1em",height:"1em",children:[(0,a.jsx)("path",{d:"M512 64c-247.424 0-448 62.72-448 140.032v112c0 77.312 200.576 139.968 448 139.968s448-62.72 448-140.032v-112C960 126.72 759.424 64 512 64z m0 728c-247.424 0-448-62.72-448-140.032v168.064C64 897.28 264.576 960 512 960s448-62.72 448-140.032v-167.936c0 77.312-200.576 139.968-448 139.968z",fill:"#3699FF","p-id":"49818"}),(0,a.jsx)("path",{d:"M512 540.032c-247.424 0-448-62.72-448-140.032v168c0 77.312 200.576 140.032 448 140.032s448-62.72 448-140.032V400c0 77.312-200.576 140.032-448 140.032z",fill:"#3699FF",opacity:".32","p-id":"49819"})]})}function S(){return(0,a.jsxs)("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"59847",width:"1em",height:"1em",children:[(0,a.jsx)("path",{d:"M149.2 99.7h726.6c27.7 0 50.1 22.4 50.1 50.1V336H99.1V149.8c0-27.6 22.4-50.1 50.1-50.1z",fill:"#1ECD93","p-id":"59848"}),(0,a.jsx)("path",{d:"M99.1 395h236.2v236.3H99.1zM99.1 690.3h236.2v236.2H149.2c-27.7 0-50.1-22.4-50.1-50.1V690.3zM394.4 395h236.2v236.3H394.4z",fill:"#1ECD93","fill-opacity":".5","p-id":"59849"}),(0,a.jsx)("path",{d:"M394.4 690.3h236.2v236.3H394.4z",fill:"#A1E6C9","p-id":"59850","data-spm-anchor-id":"a313x.search_index.0.i13.27343a81CqKUWU"}),(0,a.jsx)("path",{d:"M689.7 395h236.2v236.3H689.7z",fill:"#1ECD93","fill-opacity":".5","p-id":"59851"}),(0,a.jsx)("path",{d:"M689.7 690.3h236.2v186.1c0 27.7-22.4 50.1-50.1 50.1H689.7V690.3z",fill:"#A1E6C9","p-id":"59852","data-spm-anchor-id":"a313x.search_index.0.i17.27343a81CqKUWU"})]})}function z(){return(0,a.jsx)("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"67616",width:"1em",height:"1em",children:(0,a.jsx)("path",{d:"M39.385 204.83h346.571L252.054 976.74l-23.63 39.383h259.929v-31.506L614.379 204.83H771.91S960.951 220.584 984.581 0.038H236.3S94.52-7.84 39.384 204.83",fill:"#1296db","p-id":"67617"})})}var Z=i(94184),q=i.n(Z),C=i(91085),M=function(){return(0,a.jsx)("svg",{width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 1024 1024",version:"1.1",children:(0,a.jsx)("path",{d:"M171.85792 110.9504a58.65472 58.65472 0 0 0-58.65472 58.65472v701.9008a58.7264 58.7264 0 0 0 58.65472 58.65472h680.28416a58.7264 58.7264 0 0 0 58.65472-58.65472V169.64608a57.98912 57.98912 0 0 0-17.08032-41.41056 58.1632 58.1632 0 0 0-41.472-17.27488H171.85792z m670.60736 750.77632H181.53472V554.77248h660.93056v306.95424z m0-375.38816H181.53472V179.38432h660.93056v306.95424z","p-id":"14553"})})},H=function(){return(0,a.jsx)("svg",{width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 1024 1024",version:"1.1",children:(0,a.jsx)("path",{d:"M161.05472 919.3472h701.9008a58.71616 58.71616 0 0 0 58.65472-58.65472V180.40832a58.71616 58.71616 0 0 0-58.65472-58.65472H161.09568a58.03008 58.03008 0 0 0-41.4208 17.08032A58.1632 58.1632 0 0 0 102.4 180.30592v680.38656a58.64448 58.64448 0 0 0 58.65472 58.65472z m385.15712-589.568V190.08512h306.95424v660.93056H546.21184V329.7792zM170.83392 190.08512h306.95424v660.93056H170.83392V190.08512z","p-id":"13913"})})};let{Search:V}=u.default;function E(e){let{layout:l="LR",editorValue:i,chartData:n,tableData:o,handleChange:s}=e,r=(0,t.useMemo)(()=>n?(0,a.jsx)("div",{className:"flex-1 overflow-auto p-2",style:{flexShrink:0,overflow:"hidden"},children:(0,a.jsx)(p.ZP,{chartsData:[n]})}):null,[n]),{columns:u,dataSource:c}=(0,t.useMemo)(()=>{let{columns:e=[],values:l=[]}=null!=o?o:{},i=e.map(e=>({key:e,dataIndex:e,title:e})),a=l.map(l=>l.reduce((l,i,a)=>(l[e[a]]=i,l),{}));return{columns:i,dataSource:a}},[o]);return(0,a.jsxs)("div",{className:q()("flex w-full flex-1 h-full gap-2 overflow-hidden",{"flex-col":"TB"===l,"flex-row":"LR"===l}),children:[(0,a.jsx)("div",{className:"flex-1 flex overflow-hidden rounded",children:(0,a.jsx)(h.Z,{value:(null==i?void 0:i.sql)||"",language:"mysql",onChange:s,thoughts:(null==i?void 0:i.thoughts)||""})}),(0,a.jsxs)("div",{className:"flex-1 h-full overflow-auto bg-white dark:bg-theme-dark-container rounded p-4",children:[(null==o?void 0:o.values.length)?(0,a.jsx)(d.Z,{bordered:!0,scroll:{x:"auto"},rowKey:u[0].key,columns:u,dataSource:c}):(0,a.jsx)("div",{className:"h-full flex justify-center items-center",children:(0,a.jsx)(C.Z,{})}),r]})]})}var D=function(){var e,l,i,d,u;let[h,p]=(0,t.useState)([]),[j,b]=(0,t.useState)(""),[_,Z]=(0,t.useState)(),[C,D]=(0,t.useState)(!0),[B,R]=(0,t.useState)(),[A,P]=(0,t.useState)(),[T,L]=(0,t.useState)(),[O,F]=(0,t.useState)(),[K,U]=(0,t.useState)(),[W,Y]=(0,t.useState)(!1),[$,I]=(0,t.useState)("TB"),J=(0,m.useSearchParams)(),G=null==J?void 0:J.get("id"),Q=null==J?void 0:J.get("scene"),{data:X,loading:ee}=(0,n.Z)(async()=>await (0,x.Tk)("/v1/editor/sql/rounds",{con_uid:G}),{onSuccess:e=>{var l,i;let a=null==e?void 0:null===(l=e.data)||void 0===l?void 0:l[(null==e?void 0:null===(i=e.data)||void 0===i?void 0:i.length)-1];a&&Z(null==a?void 0:a.round)}}),{run:el,loading:ei}=(0,n.Z)(async()=>{var e,l;let i=null===(e=null==X?void 0:null===(l=X.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name;return await (0,x.PR)("/api/v1/editor/sql/run",{db_name:i,sql:null==T?void 0:T.sql})},{manual:!0,onSuccess:e=>{var l,i;F({columns:null==e?void 0:null===(l=e.data)||void 0===l?void 0:l.colunms,values:null==e?void 0:null===(i=e.data)||void 0===i?void 0:i.values})}}),{run:ea,loading:et}=(0,n.Z)(async()=>{var e,l;let i=null===(e=null==X?void 0:null===(l=X.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name,a={db_name:i,sql:null==T?void 0:T.sql};return"chat_dashboard"===Q&&(a.chart_type=null==T?void 0:T.showcase),await (0,x.PR)("/api/v1/editor/chart/run",a)},{manual:!0,ready:!!(null==T?void 0:T.sql),onSuccess:e=>{if(null==e?void 0:e.success){var l,i,a,t,n,d,o;F({columns:(null==e?void 0:null===(l=e.data)||void 0===l?void 0:null===(i=l.sql_data)||void 0===i?void 0:i.colunms)||[],values:(null==e?void 0:null===(a=e.data)||void 0===a?void 0:null===(t=a.sql_data)||void 0===t?void 0:t.values)||[]}),(null==e?void 0:null===(n=e.data)||void 0===n?void 0:n.chart_values)?R({type:null==e?void 0:null===(d=e.data)||void 0===d?void 0:d.chart_type,values:null==e?void 0:null===(o=e.data)||void 0===o?void 0:o.chart_values,title:null==T?void 0:T.title,description:null==T?void 0:T.thoughts}):R(void 0)}}}),{run:en,loading:ed}=(0,n.Z)(async()=>{var e,l,i,a,t;let n=null===(e=null==X?void 0:null===(l=X.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name;return await (0,x.PR)("/api/v1/sql/editor/submit",{conv_uid:G,db_name:n,conv_round:_,old_sql:null==A?void 0:A.sql,old_speak:null==A?void 0:A.thoughts,new_sql:null==T?void 0:T.sql,new_speak:(null===(i=null==T?void 0:null===(a=T.thoughts)||void 0===a?void 0:a.match(/^\n--(.*)\n\n$/))||void 0===i?void 0:null===(t=i[1])||void 0===t?void 0:t.trim())||(null==T?void 0:T.thoughts)})},{manual:!0,onSuccess:e=>{(null==e?void 0:e.success)&&el()}}),{run:eo,loading:es}=(0,n.Z)(async()=>{var e,l,i,a,t,n;let d=null===(e=null==X?void 0:null===(l=X.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name;return await (0,x.PR)("/api/v1/chart/editor/submit",{conv_uid:G,chart_title:null==T?void 0:T.title,db_name:d,old_sql:null==A?void 0:null===(i=A[K])||void 0===i?void 0:i.sql,new_chart_type:null==T?void 0:T.showcase,new_sql:null==T?void 0:T.sql,new_comment:(null===(a=null==T?void 0:null===(t=T.thoughts)||void 0===t?void 0:t.match(/^\n--(.*)\n\n$/))||void 0===a?void 0:null===(n=a[1])||void 0===n?void 0:n.trim())||(null==T?void 0:T.thoughts),gmt_create:new Date().getTime()})},{manual:!0,onSuccess:e=>{(null==e?void 0:e.success)&&ea()}}),{data:er}=(0,n.Z)(async()=>{var e,l;let i=null===(e=null==X?void 0:null===(l=X.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name;return await (0,x.Tk)("/v1/editor/db/tables",{db_name:i,page_index:1,page_size:200})},{ready:!!(null===(e=null==X?void 0:null===(l=X.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name),refreshDeps:[null===(i=null==X?void 0:null===(d=X.data)||void 0===d?void 0:d.find(e=>e.round===_))||void 0===i?void 0:i.db_name]}),{run:eu}=(0,n.Z)(async e=>await (0,x.Tk)("/v1/editor/sql",{con_uid:G,round:e}),{manual:!0,onSuccess:e=>{let l;try{if(Array.isArray(null==e?void 0:e.data))l=null==e?void 0:e.data,U(0);else if("string"==typeof(null==e?void 0:e.data)){let i=JSON.parse(null==e?void 0:e.data);l=i}else l=null==e?void 0:e.data}catch(e){console.log(e)}finally{P(l),Array.isArray(l)?L(null==l?void 0:l[Number(K||0)]):L(l)}}}),ec=(0,t.useMemo)(()=>{let e=(l,i)=>l.map(l=>{let t=l.title,n=t.indexOf(j),d=t.substring(0,n),s=t.slice(n+j.length),r=e=>{switch(e){case"db":return(0,a.jsx)(N,{});case"table":return(0,a.jsx)(S,{});default:return(0,a.jsx)(z,{})}},u=n>-1?(0,a.jsx)(o.Z,{title:((null==l?void 0:l.comment)||(null==l?void 0:l.title))+((null==l?void 0:l.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[r(l.type),"\xa0\xa0\xa0",d,(0,a.jsx)("span",{className:"text-[#1677ff]",children:j}),s,"\xa0",(null==l?void 0:l.type)&&(0,a.jsx)("div",{className:"text-gray-400",children:null==l?void 0:l.type})]})}):(0,a.jsx)(o.Z,{title:((null==l?void 0:l.comment)||(null==l?void 0:l.title))+((null==l?void 0:l.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[r(l.type),"\xa0\xa0\xa0",t,"\xa0",(null==l?void 0:l.type)&&(0,a.jsx)("div",{className:"text-gray-400",children:null==l?void 0:l.type})]})});if(l.children){let a=i?String(i)+"_"+l.key:l.key;return{title:t,showTitle:u,key:a,children:e(l.children,a)}}return{title:t,showTitle:u,key:l.key}});return(null==er?void 0:er.data)?(p([null==er?void 0:er.data.key]),e([null==er?void 0:er.data])):[]},[j,er]),ev=(0,t.useMemo)(()=>{let e=[],l=(i,a)=>{if(i&&!((null==i?void 0:i.length)<=0))for(let t=0;t<i.length;t++){let n=i[t],{key:d,title:o}=n;e.push({key:d,title:o,parentKey:a}),n.children&&l(n.children,d)}};return ec&&l(ec),e},[ec]),eh=(e,l)=>{let i;for(let a=0;a<l.length;a++){let t=l[a];t.children&&(t.children.some(l=>l.key===e)?i=t.key:eh(e,t.children)&&(i=eh(e,t.children)))}return i};function ex(e){let l;if(!e)return{sql:"",thoughts:""};let i=e&&e.match(/(--.*)\n([\s\S]*)/),a="";return i&&i.length>=3&&(a=i[1],l=i[2]),{sql:l,thoughts:a}}return(0,t.useEffect)(()=>{_&&eu(_)},[eu,_]),(0,t.useEffect)(()=>{A&&"chat_dashboard"===Q&&K&&ea()},[K,Q,A,ea]),(0,t.useEffect)(()=>{A&&"chat_dashboard"!==Q&&el()},[Q,A,el]),(0,a.jsxs)("div",{className:"flex flex-col w-full h-full overflow-hidden",children:[(0,a.jsx)(f.Z,{}),(0,a.jsxs)("div",{className:"relative flex flex-1 p-4 pt-0 overflow-hidden",children:[(0,a.jsxs)("div",{className:"group/side relative mr-4",children:[(0,a.jsx)("div",{className:q()("h-full relative transition-[width] overflow-hidden",{"w-0":W,"w-64":!W}),children:(0,a.jsxs)("div",{className:"relative w-64 h-full overflow-hidden flex flex-col rounded bg-white dark:bg-theme-dark-container p-4",children:[(0,a.jsx)(s.default,{size:"middle",className:"w-full mb-2",value:_,options:null==X?void 0:null===(u=X.data)||void 0===u?void 0:u.map(e=>({label:e.round_name,value:e.round})),onChange:e=>{Z(e)}}),(0,a.jsx)(V,{className:"mb-2",placeholder:"Search",onChange:e=>{let{value:l}=e.target;if(null==er?void 0:er.data){if(l){let e=ev.map(e=>e.title.indexOf(l)>-1?eh(e.key,ec):null).filter((e,l,i)=>e&&i.indexOf(e)===l);p(e)}else p([]);b(l),D(!0)}}}),ec&&ec.length>0&&(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,a.jsx)(c.Z,{onExpand:e=>{p(e),D(!1)},expandedKeys:h,autoExpandParent:C,treeData:ec,fieldNames:{title:"showTitle"}})})]})}),(0,a.jsx)("div",{className:"absolute right-0 top-0 translate-x-full h-full flex items-center justify-center opacity-0 hover:opacity-100 group-hover/side:opacity-100 transition-opacity",children:(0,a.jsx)("div",{className:"bg-white w-4 h-10 flex items-center justify-center dark:bg-theme-dark-container rounded-tr rounded-br z-10 text-xs cursor-pointer shadow-[4px_0_10px_rgba(0,0,0,0.06)] text-opacity-80",onClick:()=>{Y(!W)},children:W?(0,a.jsx)(w.Z,{}):(0,a.jsx)(g.Z,{})})})]}),(0,a.jsxs)("div",{className:"flex flex-col flex-1 max-w-full overflow-hidden",children:[(0,a.jsxs)("div",{className:"mb-2 bg-white dark:bg-theme-dark-container p-2 flex justify-between items-center",children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(r.ZP,{className:"text-xs rounded-none",size:"small",type:"primary",icon:(0,a.jsx)(y.Z,{}),loading:ei||et,onClick:async()=>{"chat_dashboard"===Q?ea():el()},children:"Run"}),(0,a.jsx)(r.ZP,{className:"text-xs rounded-none",type:"primary",size:"small",loading:ed||es,icon:(0,a.jsx)(k,{}),onClick:async()=>{"chat_dashboard"===Q?await eo():await en()},children:"Save"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(v.Z,{className:q()("flex items-center justify-center w-6 h-6 text-lg rounded",{"bg-theme-primary bg-opacity-10":"TB"===$}),component:M,onClick:()=>{I("TB")}}),(0,a.jsx)(v.Z,{className:q()("flex items-center justify-center w-6 h-6 text-lg rounded",{"bg-theme-primary bg-opacity-10":"LR"===$}),component:H,onClick:()=>{I("LR")}})]})]}),Array.isArray(A)?(0,a.jsxs)("div",{className:"flex flex-col h-full overflow-hidden",children:[(0,a.jsx)("div",{className:"w-full whitespace-nowrap overflow-x-auto bg-white dark:bg-theme-dark-container mb-2 text-[0px]",children:A.map((e,l)=>(0,a.jsx)(o.Z,{className:"inline-block",title:e.title,children:(0,a.jsx)("div",{className:q()("max-w-[240px] px-3 h-10 text-ellipsis overflow-hidden whitespace-nowrap text-sm leading-10 cursor-pointer font-semibold hover:text-theme-primary transition-colors mr-2 last-of-type:mr-0",{"border-b-2 border-solid border-theme-primary text-theme-primary":K===l}),onClick:()=>{U(l),L(null==A?void 0:A[l])},children:e.title})},e.title))}),(0,a.jsx)("div",{className:"flex flex-1 overflow-hidden",children:A.map((e,l)=>(0,a.jsx)("div",{className:q()("w-full overflow-hidden",{hidden:l!==K,"block flex-1":l===K}),children:(0,a.jsx)(E,{layout:$,editorValue:e,handleChange:e=>{let{sql:l,thoughts:i}=ex(e);L(e=>Object.assign({},e,{sql:l,thoughts:i}))},tableData:O,chartData:B})},e.title))})]}):(0,a.jsx)(E,{layout:$,editorValue:A,handleChange:e=>{let{sql:l,thoughts:i}=ex(e);L(e=>Object.assign({},e,{sql:l,thoughts:i}))},tableData:O,chartData:void 0})]})]})]})}}}]);