(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1767],{94617:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/construct/flow/canvas",function(){return a(48031)}])},48031:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return D}});var l=a(85893),n=a(76212),s=a(45247),i=a(29927),o=a(99743),d=a(58177),r=a(67919),c=a(12906),u=a(60219),f=a(79531),m=a(31418),p=a(99859),x=a(26855),h=a(96074),v=a(85576),j=a(84567),w=a(42075),b=a(14726),g=a(39332),_=a(67294),N=a(67421),y=a(36851),C=a(24885),Z=a(59819);a(4583);var k=a(11163);let{TextArea:P}=f.default,V={customNode:d.Z},E={buttonedge:o.Z},T=()=>{let{t:e}=(0,N.$G)(),{message:t}=m.Z.useApp(),{replace:a}=(0,k.useRouter)(),[o]=p.default.useForm(),d=(0,g.useSearchParams)(),T=(null==d?void 0:d.get("id"))||"",D=(0,y._K)(),[z,F]=(0,_.useState)(!1),[I,O,S]=(0,y.Rr)([]),[R,B,A]=(0,y.ll)([]),L=(0,_.useRef)(null),[X,$]=(0,_.useState)(!1),[q,K]=(0,_.useState)();async function W(){F(!0);let[e,t]=await (0,n.Vx)((0,n._d)(T));if(t){let e=(0,r.z5)(t.flow_data);K(t),O(e.nodes),B(e.edges)}F(!1)}(0,_.useEffect)(()=>{T&&W()},[T]),(0,_.useEffect)(()=>{let e=e=>{e.returnValue=t};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[]);let G=(0,_.useCallback)(e=>{e.preventDefault();let t=L.current.getBoundingClientRect(),a=e.dataTransfer.getData("application/reactflow");if(!a||void 0===a)return;let l=JSON.parse(a),n=D.screenToFlowPosition({x:e.clientX-t.left,y:e.clientY-t.top}),s=(0,r.VZ)(l,D.getNodes());l.id=s;let i={id:s,position:n,type:"customNode",data:l};O(e=>e.concat(i).map(e=>(e.id===i.id?e.data={...e.data,selected:!0}:e.data={...e.data,selected:!1},e)))},[D]),J=(0,_.useCallback)(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},[]);async function Y(){let{name:e,label:l,description:s="",editable:i=!1,deploy:d=!1}=o.getFieldsValue(),c=(0,r.Wf)(D.toObject());if(T){let[,,o]=await (0,n.Vx)((0,n.ao)(T,{name:e,label:l,description:s,editable:i,uid:T,flow_data:c,state:d?"deployed":"developing"}));$(!1),(null==o?void 0:o.success)?(t.success("编辑成功"),a("/construct/flow"),$(!1)):(null==o?void 0:o.err_msg)&&t.error(null==o?void 0:o.err_msg)}else{let[o,r]=await (0,n.Vx)((0,n.zd)({name:e,label:l,description:s,editable:i,flow_data:c,state:d?"deployed":"developing"}));$(!1),a("/construct/flow"),t.success("创建成功")}}return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.Z,{visible:z}),(0,l.jsx)("div",{className:"my-2 mx-4 flex flex-row justify-end items-center",children:(0,l.jsx)("div",{className:"w-8 h-8 rounded-md bg-stone-300 dark:bg-zinc-700 dark:text-zinc-200 flext justify-center items-center hover:text-blue-500 dark:hover:text-zinc-100",children:(0,l.jsx)(u.Z,{className:"block text-xl",onClick:function(){let e=D.toObject(),[t,a,n]=(0,r.Rv)(e);if(!t&&n)return O(e=>e.map(e=>(e.id===(null==a?void 0:a.id)?e.data={...e.data,invalid:!0}:e.data={...e.data,invalid:!1},e))),x.ZP.error({message:"Error",description:n,icon:(0,l.jsx)(c.Z,{className:"text-red-600"})});$(!0)}})})}),(0,l.jsx)(h.Z,{className:"mt-0 mb-0"}),(0,l.jsx)("div",{className:"h-[calc(100vh-60px)] w-full",ref:L,children:(0,l.jsxs)(y.x$,{nodes:I,edges:R,nodeTypes:V,edgeTypes:E,onNodesChange:S,onEdgesChange:A,onNodeClick:function(e,t){D.setNodes(e=>e.map(e=>(e.id===t.id?e.data={...e.data,selected:!0}:e.data={...e.data,selected:!1},e)))},onConnect:function(e){let t={...e,type:"buttonedge",id:"".concat(e.source,"|").concat(e.target)};B(e=>(0,y.Z_)(t,e))},onDrop:G,onDragOver:J,minZoom:.1,fitView:!0,deleteKeyCode:["Backspace","Delete"],children:[(0,l.jsx)(C.Z,{className:"flex flex-row items-center",position:"bottom-center"}),(0,l.jsx)(Z.A,{color:"#aaa",gap:16}),(0,l.jsx)(i.Z,{})]})}),(0,l.jsx)(v.default,{title:e("flow_modal_title"),open:X,onCancel:()=>{$(!1)},cancelButtonProps:{className:"hidden"},okButtonProps:{className:"hidden"},children:(0,l.jsxs)(p.default,{name:"flow_form",form:o,labelCol:{span:8},wrapperCol:{span:16},style:{maxWidth:600},initialValues:{remember:!0},onFinish:Y,autoComplete:"off",children:[(0,l.jsx)(p.default.Item,{label:"Title",name:"label",initialValue:null==q?void 0:q.label,rules:[{required:!0,message:"Please input flow title!"}],children:(0,l.jsx)(f.default,{onChange:function(e){let t=e.target.value,a=t.replace(/\s+/g,"_").replace(/[^a-z0-9_-]/g,"").toLowerCase();o.setFieldsValue({name:a})}})}),(0,l.jsx)(p.default.Item,{label:"Name",name:"name",initialValue:null==q?void 0:q.name,rules:[{required:!0,message:"Please input flow name!"},()=>({validator:(e,t)=>/^[a-zA-Z0-9_\-]+$/.test(t)?Promise.resolve():Promise.reject("Can only contain numbers, letters, underscores, and dashes")})],children:(0,l.jsx)(f.default,{})}),(0,l.jsx)(p.default.Item,{label:"Description",initialValue:null==q?void 0:q.description,name:"description",children:(0,l.jsx)(P,{rows:3})}),(0,l.jsx)(p.default.Item,{label:"Editable",name:"editable",initialValue:!T||(null==q?void 0:q.editable),valuePropName:"checked",children:(0,l.jsx)(j.Z,{})}),(0,l.jsx)(p.default.Item,{label:"Deploy",name:"deploy",initialValue:!T||(null==q?void 0:q.state)==="deployed"||(null==q?void 0:q.state)==="running",valuePropName:"checked",children:(0,l.jsx)(j.Z,{})}),(0,l.jsx)(p.default.Item,{wrapperCol:{offset:8,span:16},children:(0,l.jsxs)(w.Z,{children:[(0,l.jsx)(b.ZP,{htmlType:"button",onClick:()=>{$(!1)},children:"Cancel"}),(0,l.jsx)(b.ZP,{type:"primary",htmlType:"submit",children:"Submit"})]})})]})})]})};function D(){return(0,l.jsx)(y.tV,{children:(0,l.jsx)(T,{})})}}},function(e){e.O(0,[3662,8241,7779,3791,7656,2913,5081,6184,9859,2850,4567,1980,418,7434,9924,8133,2487,4132,9238,9774,2888,179],function(){return e(e.s=94617)}),_N_E=e.O()}]);