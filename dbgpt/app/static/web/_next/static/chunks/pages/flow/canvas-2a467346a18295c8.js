(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6997],{76735:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/flow/canvas",function(){return a(83351)}])},83351:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return T}});var l=a(85893),n=a(76212),s=a(45247),i=a(29927),d=a(99743),o=a(58177),r=a(67919),c=a(12906),u=a(60219),f=a(79531),m=a(45360),p=a(99859),x=a(26855),h=a(96074),v=a(85576),j=a(84567),w=a(42075),g=a(14726),b=a(39332),_=a(67294),C=a(67421),N=a(36851),y=a(24885),Z=a(59819);a(4583);let{TextArea:k}=f.default,P={customNode:o.Z},V={buttonedge:d.Z},E=()=>{let{t:e}=(0,C.$G)(),[t,a]=m.ZP.useMessage(),[d]=p.default.useForm(),o=(0,b.useSearchParams)(),E=(null==o?void 0:o.get("id"))||"",T=(0,N._K)(),[D,S]=(0,_.useState)(!1),[z,F,I]=(0,N.Rr)([]),[O,B,R]=(0,N.ll)([]),L=(0,_.useRef)(null),[X,$]=(0,_.useState)(!1),[q,A]=(0,_.useState)(),[K,W]=(0,_.useState)(!0);async function G(){S(!0);let[e,t]=await (0,n.Vx)((0,n._d)(E));if(t){let e=(0,r.z5)(t.flow_data);A(t),F(e.nodes),B(e.edges)}S(!1)}(0,_.useEffect)(()=>{E&&G()},[E]),(0,_.useEffect)(()=>{let e=e=>{e.returnValue=m.ZP};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[]);let J=(0,_.useCallback)(e=>{e.preventDefault();let t=L.current.getBoundingClientRect(),a=e.dataTransfer.getData("application/reactflow");if(!a||void 0===a)return;let l=JSON.parse(a),n=T.screenToFlowPosition({x:e.clientX-t.left,y:e.clientY-t.top}),s=(0,r.VZ)(l,T.getNodes());l.id=s;let i={id:s,position:n,type:"customNode",data:l};F(e=>e.concat(i).map(e=>(e.id===i.id?e.data={...e.data,selected:!0}:e.data={...e.data,selected:!1},e)))},[T]),M=(0,_.useCallback)(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},[]);async function Y(){let{name:a,label:l,description:s="",editable:i=!1,state:o="deployed"}=d.getFieldsValue(),c=(0,r.Wf)(T.toObject());if(E){let[,,d]=await (0,n.Vx)((0,n.ao)(E,{name:a,label:l,description:s,editable:i,uid:E,flow_data:c,state:o}));$(!1),(null==d?void 0:d.success)?t.success(e("save_flow_success")):(null==d?void 0:d.err_msg)&&t.error(null==d?void 0:d.err_msg)}else{let[d,r]=await (0,n.Vx)((0,n.zd)({name:a,label:l,description:s,editable:i,flow_data:c,state:o}));if(null==r?void 0:r.uid){t.success(e("save_flow_success"));let a=window.history;a.pushState(null,"","/flow/canvas?id=".concat(r.uid))}$(!1)}}return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.Z,{visible:D}),(0,l.jsx)("div",{className:"my-2 mx-4 flex flex-row justify-end items-center",children:(0,l.jsx)("div",{className:"w-8 h-8 rounded-md bg-stone-300 dark:bg-zinc-700 dark:text-zinc-200 flext justify-center items-center hover:text-blue-500 dark:hover:text-zinc-100",children:(0,l.jsx)(u.Z,{className:"block text-xl",onClick:function(){let e=T.toObject(),[t,a,n]=(0,r.Rv)(e);if(!t&&n)return F(e=>e.map(e=>(e.id===(null==a?void 0:a.id)?e.data={...e.data,invalid:!0}:e.data={...e.data,invalid:!1},e))),x.ZP.error({message:"Error",description:n,icon:(0,l.jsx)(c.Z,{className:"text-red-600"})});$(!0)}})})}),(0,l.jsx)(h.Z,{className:"mt-0 mb-0"}),(0,l.jsx)("div",{className:"h-[calc(100vh-60px)] w-full",ref:L,children:(0,l.jsxs)(N.x$,{nodes:z,edges:O,nodeTypes:P,edgeTypes:V,onNodesChange:I,onEdgesChange:R,onNodeClick:function(e,t){T.setNodes(e=>e.map(e=>(e.id===t.id?e.data={...e.data,selected:!0}:e.data={...e.data,selected:!1},e)))},onConnect:function(e){let t={...e,type:"buttonedge",id:"".concat(e.source,"|").concat(e.target)};B(e=>(0,N.Z_)(t,e))},onDrop:J,onDragOver:M,minZoom:.1,fitView:!0,deleteKeyCode:["Backspace","Delete"],children:[(0,l.jsx)(y.Z,{className:"flex flex-row items-center",position:"bottom-center"}),(0,l.jsx)(Z.A,{color:"#aaa",gap:16}),(0,l.jsx)(i.Z,{})]})}),(0,l.jsx)(v.default,{title:e("flow_modal_title"),open:X,onCancel:()=>{$(!1)},cancelButtonProps:{className:"hidden"},okButtonProps:{className:"hidden"},children:(0,l.jsxs)(p.default,{name:"flow_form",form:d,labelCol:{span:8},wrapperCol:{span:16},style:{maxWidth:600},initialValues:{remember:!0},onFinish:Y,autoComplete:"off",children:[(0,l.jsx)(p.default.Item,{label:"Title",name:"label",initialValue:null==q?void 0:q.label,rules:[{required:!0,message:"Please input flow title!"}],children:(0,l.jsx)(f.default,{onChange:function(e){let t=e.target.value,a=t.replace(/\s+/g,"_").replace(/[^a-z0-9_-]/g,"").toLowerCase();d.setFieldsValue({name:a})}})}),(0,l.jsx)(p.default.Item,{label:"Name",name:"name",initialValue:null==q?void 0:q.name,rules:[{required:!0,message:"Please input flow name!"},()=>({validator:(e,t)=>/^[a-zA-Z0-9_\-]+$/.test(t)?Promise.resolve():Promise.reject("Can only contain numbers, letters, underscores, and dashes")})],children:(0,l.jsx)(f.default,{})}),(0,l.jsx)(p.default.Item,{label:"Description",initialValue:null==q?void 0:q.description,name:"description",children:(0,l.jsx)(k,{rows:3})}),(0,l.jsx)(p.default.Item,{label:"Editable",name:"editable",initialValue:null==q?void 0:q.editable,valuePropName:"checked",children:(0,l.jsx)(j.Z,{})}),(0,l.jsx)(p.default.Item,{hidden:!0,name:"state",children:(0,l.jsx)(f.default,{})}),(0,l.jsx)(p.default.Item,{label:"Deploy",children:(0,l.jsx)(j.Z,{defaultChecked:(null==q?void 0:q.state)==="deployed"||(null==q?void 0:q.state)==="running",value:K,onChange:e=>{let t=e.target.checked;d.setFieldValue("state",t?"deployed":"developing"),W(t)}})}),(0,l.jsx)(p.default.Item,{wrapperCol:{offset:8,span:16},children:(0,l.jsxs)(w.Z,{children:[(0,l.jsx)(g.ZP,{htmlType:"button",onClick:()=>{$(!1)},children:"Cancel"}),(0,l.jsx)(g.ZP,{type:"primary",htmlType:"submit",children:"Submit"})]})})]})}),a]})};function T(){return(0,l.jsx)(N.tV,{children:(0,l.jsx)(E,{})})}}},function(e){e.O(0,[3662,8241,7779,3791,7656,2913,5081,6184,9859,2850,4567,1980,418,7434,9924,8133,2487,4132,9238,9774,2888,179],function(){return e(e.s=76735)}),_N_E=e.O()}]);