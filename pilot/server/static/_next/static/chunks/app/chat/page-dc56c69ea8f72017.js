(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[929],{86066:function(e,l,t){Promise.resolve().then(t.bind(t,50229))},50229:function(e,l,t){"use strict";t.r(l),t.d(l,{default:function(){return e_}});var a=t(9268),n=t(86006),s=t(57931),i=t(11196),r=t(83192),o=t(35891),d=t(22046),c=t(53113),u=t(71451),h=t(24857),v=t(90545),x=t(48755),m=t(56959),f=t(76447),p=t(61469),j=t(98222),g=t(84257),y=t(77055);function b(e){let{value:l,language:t="mysql",onChange:s,thoughts:i}=e,r=(0,n.useMemo)(()=>i&&i.length>0?"-- ".concat(i," \n").concat(l):l,[l,i]);return(0,a.jsx)(g.ZP,{value:(0,y.WU)(r),language:t,onChange:s,theme:"vs-dark",options:{minimap:{enabled:!1},wordWrap:"on"}})}var w=t(89749),Z=t(56008),_=t(90022),N=t(8997),S=t(91440),P=t(84835),k=t.n(P),C=function(e){let{type:l,values:t,title:s,description:i}=e,o=n.useMemo(()=>{if(!((null==t?void 0:t.length)>0))return(0,a.jsx)("div",{className:"h-full",children:(0,a.jsx)(f.Z,{image:f.Z.PRESENTED_IMAGE_SIMPLE,description:"图表数据为空"})});if("IndicatorValue"!==l){if("Table"===l){var e,n,s;let l=k().groupBy(t,"type");return(0,a.jsx)("div",{className:"flex-1 overflow-auto",children:(0,a.jsxs)(r.Z,{"aria-label":"basic table",hoverRow:!0,stickyHeader:!0,children:[(0,a.jsx)("thead",{children:(0,a.jsx)("tr",{children:Object.keys(l).map(e=>(0,a.jsx)("th",{children:e},e))})}),(0,a.jsx)("tbody",{children:null===(e=Object.values(l))||void 0===e?void 0:null===(n=e[0])||void 0===n?void 0:null===(s=n.map)||void 0===s?void 0:s.call(n,(e,t)=>{var n;return(0,a.jsx)("tr",{children:null===(n=Object.keys(l))||void 0===n?void 0:n.map(e=>{var n;return(0,a.jsx)("td",{children:(null==l?void 0:null===(n=l[e])||void 0===n?void 0:n[t].value)||""},e)})},t)})})]})})}return"BarChart"===l?(0,a.jsx)("div",{className:"flex-1 h-full",children:(0,a.jsxs)(S.Chart,{autoFit:!0,data:t||[],forceUpdate:!0,children:[(0,a.jsx)(S.Interval,{position:"name*value",style:{lineWidth:3,stroke:(0,S.getTheme)().colors10[0]}}),(0,a.jsx)(S.Tooltip,{shared:!0})]})}):"LineChart"===l?(0,a.jsx)("div",{className:"flex-1 h-full",children:(0,a.jsx)(S.Chart,{forceUpdate:!0,autoFit:!0,data:t||[],children:(0,a.jsx)(S.LineAdvance,{shape:"smooth",point:!0,area:!0,position:"name*value",color:"type"})})}):(0,a.jsx)("div",{className:"h-full",children:(0,a.jsx)(f.Z,{image:f.Z.PRESENTED_IMAGE_SIMPLE,description:"暂不支持该图表类型"})})}},[t,l]);return"IndicatorValue"===l&&(null==t?void 0:t.length)>0?(0,a.jsx)("div",{className:"flex flex-row gap-3",children:t.map(e=>(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(_.Z,{sx:{background:"transparent"},children:(0,a.jsxs)(N.Z,{className:"justify-around",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:e.name}),(0,a.jsx)(d.ZP,{children:"".concat(e.type,": ").concat(e.value)})]})})},e.name))}):(0,a.jsx)("div",{className:"flex-1 h-full",children:(0,a.jsx)(_.Z,{className:"h-full overflow-auto",sx:{background:"transparent"},children:(0,a.jsxs)(N.Z,{className:"h-full",children:[s&&(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:s}),i&&(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",children:i}),o]})})})};let{Search:E}=m.default;function O(e){var l,t,s;let{editorValue:i,chartData:o,tableData:d,handleChange:c}=e,u=n.useMemo(()=>o?(0,a.jsx)("div",{className:"flex-1 overflow-auto p-3",style:{flexShrink:0,overflow:"hidden"},children:(0,a.jsx)(C,{...o})}):(0,a.jsx)("div",{}),[o]);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,a.jsx)("div",{className:"flex-1",style:{flexShrink:0,overflow:"auto"},children:(0,a.jsx)(b,{value:(null==i?void 0:i.sql)||"",language:"mysql",onChange:c,thoughts:(null==i?void 0:i.thoughts)||""})}),u]}),(0,a.jsx)("div",{className:"h-96 border-[var(--joy-palette-divider)] border-t border-solid overflow-auto",children:(null==d?void 0:null===(l=d.values)||void 0===l?void 0:l.length)>0?(0,a.jsxs)(r.Z,{"aria-label":"basic table",stickyHeader:!0,children:[(0,a.jsx)("thead",{children:(0,a.jsx)("tr",{children:null==d?void 0:null===(t=d.columns)||void 0===t?void 0:t.map((e,l)=>(0,a.jsx)("th",{children:e},e+l))})}),(0,a.jsx)("tbody",{children:null==d?void 0:null===(s=d.values)||void 0===s?void 0:s.map((e,l)=>{var t;return(0,a.jsx)("tr",{children:null===(t=Object.keys(e))||void 0===t?void 0:t.map(l=>(0,a.jsx)("td",{children:e[l]},l))},l)})})]}):(0,a.jsx)("div",{className:"h-full flex justify-center items-center",children:(0,a.jsx)(f.Z,{})})})]})}var R=function(){var e,l,t,s,r;let[m,f]=n.useState([]),[g,y]=n.useState([]),[b,_]=n.useState(""),[N,S]=n.useState(),[P,k]=n.useState(!0),[C,R]=n.useState(),[q,T]=n.useState(),[A,B]=n.useState(),[L,D]=n.useState(),[I,M]=n.useState(),F=(0,Z.useSearchParams)(),U=F.get("id"),z=F.get("scene"),{data:J,loading:W}=(0,i.Z)(async()=>await (0,w.Tk)("/v1/editor/sql/rounds",{con_uid:U}),{onSuccess:e=>{var l,t;let a=null==e?void 0:null===(l=e.data)||void 0===l?void 0:l[(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.length)-1];a&&S(null==a?void 0:a.round)}}),{run:V,loading:H}=(0,i.Z)(async()=>{var e,l;let t=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===N))||void 0===e?void 0:e.db_name;return await (0,w.PR)("/api/v1/editor/sql/run",{db_name:t,sql:null==A?void 0:A.sql})},{manual:!0,onSuccess:e=>{var l,t;D({columns:null==e?void 0:null===(l=e.data)||void 0===l?void 0:l.colunms,values:null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.values})}}),{run:G,loading:K}=(0,i.Z)(async()=>{var e,l;let t=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===N))||void 0===e?void 0:e.db_name,a={db_name:t,sql:null==A?void 0:A.sql};return"chat_dashboard"===z&&(a.chart_type=null==A?void 0:A.showcase),await (0,w.PR)("/api/v1/editor/chart/run",a)},{manual:!0,ready:!!(null==A?void 0:A.sql),onSuccess:e=>{if(null==e?void 0:e.success){var l,t,a,n,s,i,r;D({columns:(null==e?void 0:null===(l=e.data)||void 0===l?void 0:null===(t=l.sql_data)||void 0===t?void 0:t.colunms)||[],values:(null==e?void 0:null===(a=e.data)||void 0===a?void 0:null===(n=a.sql_data)||void 0===n?void 0:n.values)||[]}),(null==e?void 0:null===(s=e.data)||void 0===s?void 0:s.chart_values)?R({type:null==e?void 0:null===(i=e.data)||void 0===i?void 0:i.chart_type,values:null==e?void 0:null===(r=e.data)||void 0===r?void 0:r.chart_values,title:null==A?void 0:A.title,description:null==A?void 0:A.thoughts}):R(void 0)}}}),{run:Y,loading:$}=(0,i.Z)(async()=>{var e,l,t,a,n;let s=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===N))||void 0===e?void 0:e.db_name;return await (0,w.PR)("/api/v1/sql/editor/submit",{conv_uid:U,db_name:s,conv_round:N,old_sql:null==q?void 0:q.sql,old_speak:null==q?void 0:q.thoughts,new_sql:null==A?void 0:A.sql,new_speak:(null===(t=null==A?void 0:null===(a=A.thoughts)||void 0===a?void 0:a.match(/^\n--(.*)\n\n$/))||void 0===t?void 0:null===(n=t[1])||void 0===n?void 0:n.trim())||(null==A?void 0:A.thoughts)})},{manual:!0,onSuccess:e=>{(null==e?void 0:e.success)&&V()}}),{run:Q,loading:X}=(0,i.Z)(async()=>{var e,l,t,a,n,s;let i=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===N))||void 0===e?void 0:e.db_name;return await (0,w.PR)("/api/v1/chart/editor/submit",{conv_uid:U,chart_title:null==A?void 0:A.title,db_name:i,old_sql:null==q?void 0:null===(t=q[I])||void 0===t?void 0:t.sql,new_chart_type:null==A?void 0:A.showcase,new_sql:null==A?void 0:A.sql,new_comment:(null===(a=null==A?void 0:null===(n=A.thoughts)||void 0===n?void 0:n.match(/^\n--(.*)\n\n$/))||void 0===a?void 0:null===(s=a[1])||void 0===s?void 0:s.trim())||(null==A?void 0:A.thoughts),gmt_create:new Date().getTime()})},{manual:!0,onSuccess:e=>{(null==e?void 0:e.success)&&G()}}),{data:ee}=(0,i.Z)(async()=>{var e,l;let t=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===N))||void 0===e?void 0:e.db_name;return await (0,w.Tk)("/v1/editor/db/tables",{db_name:t,page_index:1,page_size:200})},{ready:!!(null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===N))||void 0===e?void 0:e.db_name),refreshDeps:[null===(t=null==J?void 0:null===(s=J.data)||void 0===s?void 0:s.find(e=>e.round===N))||void 0===t?void 0:t.db_name]}),{run:el}=(0,i.Z)(async e=>await (0,w.Tk)("/v1/editor/sql",{con_uid:U,round:e}),{manual:!0,onSuccess:e=>{let l;try{if(Array.isArray(null==e?void 0:e.data))l=null==e?void 0:e.data,M("0");else if("string"==typeof(null==e?void 0:e.data)){let t=JSON.parse(null==e?void 0:e.data);l=t}else l=null==e?void 0:e.data}catch(e){console.log(e)}finally{T(l),Array.isArray(l)?B(null==l?void 0:l[Number(I||0)]):B(l)}}}),et=n.useMemo(()=>{let e=(l,t)=>l.map(l=>{let n=l.title,s=n.indexOf(b),i=n.substring(0,s),r=n.slice(s+b.length),c=s>-1?(0,a.jsx)(o.Z,{title:((null==l?void 0:l.comment)||(null==l?void 0:l.title))+((null==l?void 0:l.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("span",{children:[i,(0,a.jsx)("span",{className:"text-[#1677ff]",children:b}),r,(null==l?void 0:l.type)&&(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",className:"pl-0.5",style:{display:"inline"},children:"[".concat(null==l?void 0:l.type,"]")})]})}):(0,a.jsx)(o.Z,{title:((null==l?void 0:l.comment)||(null==l?void 0:l.title))+((null==l?void 0:l.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("span",{children:[n,(null==l?void 0:l.type)&&(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",className:"pl-0.5",style:{display:"inline"},children:"[".concat(null==l?void 0:l.type,"]")})]})});if(l.children){let a=t?String(t)+"_"+l.key:l.key;return{title:n,showTitle:c,key:a,children:e(l.children,a)}}return{title:n,showTitle:c,key:l.key}});return(null==ee?void 0:ee.data)?(f([null==ee?void 0:ee.data.key]),e([null==ee?void 0:ee.data])):[]},[b,ee]),ea=n.useMemo(()=>{let e=[],l=(t,a)=>{if(t&&!((null==t?void 0:t.length)<=0))for(let n=0;n<t.length;n++){let s=t[n],{key:i,title:r}=s;e.push({key:i,title:r,parentKey:a}),s.children&&l(s.children,i)}};return et&&l(et),e},[et]),en=(e,l)=>{let t;for(let a=0;a<l.length;a++){let n=l[a];n.children&&(n.children.some(l=>l.key===e)?t=n.key:en(e,n.children)&&(t=en(e,n.children)))}return t};return n.useEffect(()=>{N&&el(N)},[el,N]),n.useEffect(()=>{q&&"chat_dashboard"===z&&I&&G()},[I,z,q,G]),n.useEffect(()=>{q&&"chat_dashboard"!==z&&V()},[z,q,V]),(0,a.jsxs)("div",{className:"flex flex-col w-full h-full",children:[(0,a.jsx)("div",{className:"bg-[#f8f8f8] border-[var(--joy-palette-divider)] border-b border-solid flex items-center px-3 justify-between",children:(0,a.jsxs)("div",{className:"absolute right-4 top-2",children:[(0,a.jsx)(c.Z,{className:"bg-[#1677ff] text-[#fff] hover:bg-[#1c558e] px-4 cursor-pointer",loading:H||K,size:"sm",onClick:async()=>{"chat_dashboard"===z?G():V()},children:"Run"}),(0,a.jsx)(c.Z,{variant:"outlined",size:"sm",className:"ml-3 px-4 cursor-pointer",loading:$||X,onClick:async()=>{"chat_dashboard"===z?await Q():await Y()},children:"Save"})]})}),(0,a.jsxs)("div",{className:"flex flex-1 overflow-auto",children:[(0,a.jsxs)("div",{className:"text h-full border-[var(--joy-palette-divider)] border-r border-solid p-3 max-h-full overflow-auto",style:{width:"300px"},children:[(0,a.jsxs)("div",{className:"flex items-center py-3",children:[(0,a.jsx)(u.Z,{className:"h-4 min-w-[240px]",size:"sm",value:N,onChange:(e,l)=>{S(l)},children:null==J?void 0:null===(r=J.data)||void 0===r?void 0:r.map(e=>(0,a.jsx)(h.Z,{value:null==e?void 0:e.round,children:null==e?void 0:e.round_name},null==e?void 0:e.round))}),(0,a.jsx)(x.Z,{className:"ml-2"})]}),(0,a.jsx)(E,{style:{marginBottom:8},placeholder:"Search",onChange:e=>{let{value:l}=e.target;if(null==ee?void 0:ee.data){if(l){let e=ea.map(e=>e.title.indexOf(l)>-1?en(e.key,et):null).filter((e,l,t)=>e&&t.indexOf(e)===l);f(e)}else f([]);_(l),k(!0)}}}),et&&et.length>0&&(0,a.jsx)(p.Z,{onExpand:e=>{f(e),k(!1)},expandedKeys:m,autoExpandParent:P,treeData:et,fieldNames:{title:"showTitle"}})]}),(0,a.jsx)("div",{className:"flex flex-col flex-1 max-w-full overflow-hidden",children:Array.isArray(q)?(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(v.Z,{className:"h-full",sx:{".ant-tabs-content, .ant-tabs-tabpane-active":{height:"100%"},"& .ant-tabs-card.ant-tabs-top >.ant-tabs-nav .ant-tabs-tab, & .ant-tabs-card.ant-tabs-top >div>.ant-tabs-nav .ant-tabs-tab":{borderRadius:"0"}},children:(0,a.jsx)(j.Z,{className:"h-full dark:text-white px-2",activeKey:I,onChange:e=>{M(e),B(null==q?void 0:q[Number(e)])},items:null==q?void 0:q.map((e,l)=>({key:l+"",label:null==e?void 0:e.title,children:(0,a.jsx)("div",{className:"flex flex-col h-full",children:(0,a.jsx)(O,{editorValue:e,handleChange:(e,l)=>{if(A){let t=JSON.parse(JSON.stringify(A));t.sql=e,t.thoughts=l,B(t)}},tableData:L,chartData:C})})}))})})}):(0,a.jsx)(O,{editorValue:q,handleChange:(e,l)=>{B({thoughts:l,sql:e})},tableData:L,chartData:void 0})})]})]})},q=t(69962),T=t(97287),A=t(73141),B=t(45642),L=t(71990),D=e=>{let l=(0,n.useReducer)((e,l)=>({...e,...l}),{...e});return l},I=t(21628),M=t(52040),F=e=>{let{queryAgentURL:l,channel:t,queryBody:a,initHistory:i,runHistoryList:r}=e,[o,d]=D({history:i||[]}),c=(0,Z.useSearchParams)(),u=c.get("id"),{refreshDialogList:h}=(0,s.Cg)(),v=new AbortController;(0,n.useEffect)(()=>{i&&d({history:i})},[i]);let x=async(e,n)=>{if(!e)return;let s=[...o.history,{role:"human",context:e}],i=s.length;d({history:s});let r={conv_uid:u,...n,...a,user_input:e,channel:t};if(!(null==r?void 0:r.conv_uid)){I.ZP.error("conv_uid 不存在，请刷新后重试");return}try{await (0,L.L)("".concat(M.env.API_BASE_URL?M.env.API_BASE_URL:"").concat("/api"+l),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:v.signal,openWhenHidden:!0,async onopen(e){if(s.length<=1){var l;h();let e=new URLSearchParams(window.location.search);e.delete("initMessage"),null===(l=window.history)||void 0===l||l.replaceState(null,null,"?".concat(e.toString()))}(!e.ok||e.headers.get("content-type")!==L.a)&&e.status>=400&&e.status<500&&429!==e.status&&e.status},onclose(){console.log("onclose")},onerror(e){throw console.log("onerror"),Error(e)},onmessage:e=>{var l,t,a;if(e.data=null===(l=e.data)||void 0===l?void 0:l.replaceAll("\\n","\n"),"[DONE]"===e.data);else if(null===(t=e.data)||void 0===t?void 0:t.startsWith("[ERROR]"))d({history:[...s,{role:"view",context:null===(a=e.data)||void 0===a?void 0:a.replace("[ERROR]","")}]});else{let l=[...s];e.data&&((null==l?void 0:l[i])?l[i].context="".concat(e.data):l.push({role:"view",context:e.data}),d({history:l}))}}})}catch(e){console.log(e),d({history:[...s,{role:"view",context:"Sorry, We meet some error, please try agin later."}]})}};return{handleChatSubmit:x,history:o.history}},U=t(67830),z=t(54842),J=t(80937),W=t(311),V=t(94244),H=t(35086),G=t(53047),K=t(95066),Y=t(30530),$=t(64747),Q=t(19700),X=t(92391),ee=t(55749),el=t(70781),et=t(42599),ea=t(99398),en=t(49064),es=t(71563),ei=t(86362),er=t(50946),eo=t(52276),ed=t(53534),ec=t(24946),eu=t(98479),eh=t(81616),ev=function(e){var l,t;let{convUid:s,chatMode:i,fileName:r,onComplete:o,...d}=e,[c,u]=(0,n.useState)(!1),[h,v]=(0,n.useState)([]),[x,m]=(0,n.useState)(),[f,p]=(0,n.useState)(),j=async e=>{var l;if(!e){I.ZP.error("Please select the *.(csv|xlsx|xls) file");return}if(!/\.(csv|xlsx|xls)$/.test(null!==(l=e.file.name)&&void 0!==l?l:"")){I.ZP.error("File type must be csv, xlsx or xls");return}v([e.file])},g=async()=>{u(!0),p("normal");try{let e=new FormData;e.append("doc_file",h[0]);let{success:l,err_msg:t}=await ed.Z.post("/api/v1/chat/mode/params/file/load?conv_uid=".concat(s,"&chat_mode=").concat(i),e,{timeout:36e5,headers:{"Content-Type":"multipart/form-data"},onUploadProgress(e){let l=Math.ceil(e.loaded/(e.total||0)*100);m(l)}});if(!l){I.ZP.error(t);return}I.ZP.success("success"),p("success"),o()}catch(e){p("exception"),I.ZP.error((null==e?void 0:e.message)||"Upload Error")}finally{u(!1)}};return(0,a.jsxs)("div",{className:"w-full",children:[!r&&(0,a.jsxs)("div",{className:"flex items-start",children:[(0,a.jsx)(es.Z,{placement:"topLeft",title:"Files cannot be changed after upload",children:(0,a.jsx)(ei.default,{disabled:c,className:"mr-1",beforeUpload:()=>!1,fileList:h,name:"file",accept:".csv,.xlsx,.xls",multiple:!1,onChange:j,showUploadList:{showDownloadIcon:!1,showPreviewIcon:!1,showRemoveIcon:!1},itemRender:()=>(0,a.jsx)(a.Fragment,{}),...d,children:(0,a.jsx)(er.ZP,{className:"flex justify-center items-center dark:bg-[#4e4f56] dark:text-gray-200",disabled:c,icon:(0,a.jsx)(ec.Z,{}),children:"Select File"})})}),(0,a.jsx)(er.ZP,{type:"primary",loading:c,className:"flex justify-center items-center",disabled:!h.length,icon:(0,a.jsx)(eu.Z,{}),onClick:g,children:c?100===x?"Analysis":"Uploading":"Upload"})]}),(!!h.length||r)&&(0,a.jsxs)("div",{className:"mt-2 text-gray-500 text-sm flex items-center",children:[(0,a.jsx)(eh.Z,{className:"mr-2"}),(0,a.jsx)("span",{children:null!==(t=null==h?void 0:null===(l=h[0])||void 0===l?void 0:l.name)&&void 0!==t?t:r})]}),("number"==typeof x||!!r)&&(0,a.jsx)(eo.Z,{className:"mb-0",percent:r?100:x,size:"small",status:r?"success":f})]})};let ex=X.z.object({query:X.z.string().min(1)});var em=e=>{var l;let{messages:s,dialogue:i,onSubmit:r,readOnly:o,paramsList:d,onRefreshHistory:x,clearIntialMessage:m,setChartsData:f}=e,p=(0,Z.useSearchParams)(),j=p.get("initMessage"),g=p.get("spaceNameOriginal"),y=p.get("id"),b=p.get("scene"),w="chat_dashboard"===b,N=(0,n.useRef)(null),[S,P]=(0,n.useState)(!1),[C,E]=(0,n.useState)(),[O,R]=(0,n.useState)(!1),[q,T]=(0,n.useState)(),[A,B]=(0,n.useState)(s),[L,D]=(0,n.useState)(""),M=(0,Q.cI)({resolver:(0,U.F)(ex),defaultValues:{}}),F=async e=>{let{query:l}=e;try{P(!0),M.reset(),await r(l,{select_param:"chat_excel"===b?null==i?void 0:i.select_param:null==d?void 0:d[C]})}catch(e){}finally{P(!1)}},X=async()=>{try{var e;let l=new URLSearchParams(window.location.search),t=l.get("initMessage");l.delete("initMessage"),null===(e=window.history)||void 0===e||e.replaceState(null,null,"?".concat(l.toString())),await F({query:t})}catch(e){console.log(e)}finally{null==m||m()}},es={overrides:{code:e=>{let{children:l}=e;return(0,a.jsx)(ea.Z,{language:"javascript",style:en.Z,children:l})}},wrapper:n.Fragment},ei=e=>{let l=e;try{l=JSON.parse(e)}catch(e){console.log(e)}return l},er=(0,n.useMemo)(()=>{if("function"==typeof(null==window?void 0:window.fetch)){let e=t(62631);return t(25204),t(82372),e.default}},[]);return(0,n.useEffect)(()=>{N.current&&N.current.scrollTo(0,N.current.scrollHeight)},[null==s?void 0:s.length]),(0,n.useEffect)(()=>{j&&s.length<=0&&X()},[j,s.length]),(0,n.useEffect)(()=>{var e,l;d&&(null===(e=Object.keys(d||{}))||void 0===e?void 0:e.length)>0&&E(g||(null===(l=Object.keys(d||{}))||void 0===l?void 0:l[0]))},[d]),(0,n.useEffect)(()=>{if(w){let e=k().cloneDeep(s);e.forEach(e=>{(null==e?void 0:e.role)==="view"&&"string"==typeof(null==e?void 0:e.context)&&(e.context=ei(null==e?void 0:e.context))}),B(e.filter(e=>["view","human"].includes(e.role)))}else B(s.filter(e=>["view","human"].includes(e.role)))},[w,s]),(0,a.jsxs)("div",{className:"w-full h-full",children:[(0,a.jsxs)(J.Z,{className:"w-full h-full bg-[#fefefe] dark:bg-[#212121]",sx:{table:{borderCollapse:"collapse",border:"1px solid #ccc",width:"100%"},"th, td":{border:"1px solid #ccc",padding:"10px",textAlign:"center"}},children:[(0,a.jsxs)(J.Z,{ref:N,direction:"column",sx:{overflowY:"auto",maxHeight:"100%",flex:1},children:[null==A?void 0:A.map((e,l)=>{var t,n;return(0,a.jsx)(J.Z,{children:(0,a.jsx)(_.Z,{size:"sm",variant:"outlined",color:"view"===e.role?"primary":"neutral",sx:l=>({background:"view"===e.role?"var(--joy-palette-primary-softBg, var(--joy-palette-primary-100, #DDF1FF))":"unset",border:"unset",borderRadius:"unset",padding:"24px 0 26px 0",lineHeight:"24px"}),children:(0,a.jsxs)(v.Z,{sx:{width:"76%",margin:"0 auto"},className:"flex flex-row",children:["view"===e.role?(0,a.jsx)(el.Z,{className:"mr-2 mt-1"}):(0,a.jsx)(ee.Z,{className:"mr-2 mt-1"}),(0,a.jsx)("div",{className:"inline align-middle mt-0.5 max-w-full flex-1 overflow-auto",children:w&&"view"===e.role&&"object"==typeof(null==e?void 0:e.context)?(0,a.jsxs)(a.Fragment,{children:["[".concat(e.context.template_name,"]: "),(0,a.jsx)(W.Z,{sx:{color:"#1677ff"},component:"button",onClick:()=>{R(!0),T(l),D(JSON.stringify(null==e?void 0:e.context,null,2))},children:e.context.template_introduce||"More Details"})]}):(0,a.jsx)(a.Fragment,{children:"string"==typeof e.context&&(0,a.jsx)(et.Z,{options:es,children:null===(t=e.context)||void 0===t?void 0:null===(n=t.replaceAll)||void 0===n?void 0:n.call(t,"\\n","\n")})})})]})})},l)}),S&&(0,a.jsx)(V.Z,{variant:"soft",color:"neutral",size:"sm",sx:{mx:"auto",my:2}})]}),!o&&(0,a.jsx)(v.Z,{className:"bg-[#fefefe] dark:bg-[#212121] before:bg-[#fefefe] before:dark:bg-[#212121]",sx:{position:"relative","&::before":{content:'" "',position:"absolute",top:"-18px",left:"0",right:"0",width:"100%",margin:"0 auto",height:"20px",filter:"blur(10px)",zIndex:2}},children:(0,a.jsxs)("form",{style:{maxWidth:"100%",width:"76%",position:"relative",display:"flex",marginTop:"auto",overflow:"visible",background:"none",justifyContent:"center",marginLeft:"auto",marginRight:"auto",flexDirection:"column",gap:"12px",paddingBottom:"58px",paddingTop:"20px"},onSubmit:e=>{e.stopPropagation(),M.handleSubmit(F)(e)},children:[(0,a.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[Object.keys(d||{}).length>0&&(0,a.jsx)("div",{className:"flex items-center gap-3",children:(0,a.jsx)(u.Z,{value:C,onChange:(e,l)=>{E(l)},sx:{maxWidth:"100%"},children:null===(l=Object.keys(d||{}))||void 0===l?void 0:l.map(e=>(0,a.jsx)(h.Z,{value:e,children:e},e))})}),"chat_excel"===b&&(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(ev,{convUid:y,chatMode:b,fileName:null==i?void 0:i.select_param,onComplete:()=>{null==m||m(),null==x||x()}})})]}),(0,a.jsx)(H.ZP,{disabled:"chat_excel"===b&&!(null==i?void 0:i.select_param),className:"w-full h-12",variant:"outlined",endDecorator:(0,a.jsx)(G.ZP,{type:"submit",disabled:S,children:(0,a.jsx)(z.Z,{})}),...M.register("query")})]})})]}),(0,a.jsx)(K.Z,{open:O,onClose:()=>{R(!1)},children:(0,a.jsxs)(Y.Z,{"aria-labelledby":"variant-modal-title","aria-describedby":"variant-modal-description",children:[(0,a.jsx)($.Z,{}),(0,a.jsxs)(v.Z,{sx:{marginTop:"32px"},children:[!!er&&(0,a.jsx)(er,{mode:"json",value:L,height:"600px",width:"820px",onChange:D,placeholder:"默认json数据",debounceChangePeriod:100,showPrintMargin:!0,showGutter:!0,highlightActiveLine:!0,setOptions:{useWorker:!0,showLineNumbers:!0,highlightSelectedWord:!0,tabSize:2}}),(0,a.jsx)(c.Z,{variant:"outlined",className:"w-full",sx:{marginTop:"12px"},onClick:()=>{if(q)try{let e=k().cloneDeep(A),l=JSON.parse(L);e[q].context=l,B(e),null==f||f(null==l?void 0:l.charts),R(!1),D("")}catch(e){I.ZP.error("JSON 格式化出错")}},children:"Submit"})]})]})})]})};function ef(e){let{key:l,chart:t}=e;return(0,a.jsx)("div",{className:"flex-1 min-w-0",children:(0,a.jsx)(_.Z,{className:"h-full",sx:{background:"transparent"},children:(0,a.jsxs)(N.Z,{className:"h-full",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:t.chart_name}),(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",children:t.chart_desc}),(0,a.jsx)("div",{className:"h-[300px]",children:(0,a.jsx)(S.Chart,{autoFit:!0,data:t.values,children:(0,a.jsx)(S.LineAdvance,{shape:"smooth",point:!0,area:!0,position:"name*value",color:"type"})})})]})})},l)}function ep(e){let{key:l,chart:t}=e;return(0,a.jsx)("div",{className:"flex-1 min-w-0",children:(0,a.jsx)(_.Z,{className:"h-full",sx:{background:"transparent"},children:(0,a.jsxs)(N.Z,{className:"h-full",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:t.chart_name}),(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",children:t.chart_desc}),(0,a.jsx)("div",{className:"h-[300px]",children:(0,a.jsxs)(S.Chart,{autoFit:!0,data:t.values,children:[(0,a.jsx)(S.Interval,{position:"name*value",style:{lineWidth:3,stroke:(0,S.getTheme)().colors10[0]}}),(0,a.jsx)(S.Tooltip,{shared:!0})]})})]})})},l)}function ej(e){var l,t;let{key:n,chart:s}=e,i=(0,P.groupBy)(s.values,"type");return(0,a.jsx)("div",{className:"flex-1 min-w-0",children:(0,a.jsx)(_.Z,{className:"h-full overflow-auto",sx:{background:"transparent"},children:(0,a.jsxs)(N.Z,{className:"h-full",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:s.chart_name}),"\xb7",(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",children:s.chart_desc}),(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsxs)(r.Z,{"aria-label":"basic table",stripe:"odd",hoverRow:!0,borderAxis:"bothBetween",children:[(0,a.jsx)("thead",{children:(0,a.jsx)("tr",{children:Object.keys(i).map(e=>(0,a.jsx)("th",{children:e},e))})}),(0,a.jsx)("tbody",{children:null===(l=Object.values(i))||void 0===l?void 0:null===(t=l[0])||void 0===t?void 0:t.map((e,l)=>{var t;return(0,a.jsx)("tr",{children:null===(t=Object.keys(i))||void 0===t?void 0:t.map(e=>{var t;return(0,a.jsx)("td",{children:(null==i?void 0:null===(t=i[e])||void 0===t?void 0:t[l].value)||""},e)})},l)})})]})})]})})},n)}let eg=()=>(0,a.jsxs)(_.Z,{className:"h-full w-full flex bg-transparent",children:[(0,a.jsx)(q.Z,{animation:"wave",variant:"text",level:"body2"}),(0,a.jsx)(q.Z,{animation:"wave",variant:"text",level:"body2"}),(0,a.jsx)(T.Z,{ratio:"21/9",className:"flex-1",sx:{["& .".concat(A.Z.content)]:{height:"100%"}},children:(0,a.jsx)(q.Z,{variant:"overlay",className:"h-full"})})]});var ey=()=>{var e;let[l,t]=(0,n.useState)();n.useRef(null);let[r,o]=n.useState(!1),c=(0,Z.useSearchParams)(),{dialogueList:u,refreshDialogList:h}=(0,s.Cg)(),x=c.get("id"),m=c.get("scene"),f=(0,n.useMemo)(()=>(null!==(e=null==u?void 0:u.data)&&void 0!==e?e:[]).find(e=>e.conv_uid===x),[x,u]),{data:p,run:j}=(0,i.Z)(async()=>await (0,w.Tk)("/v1/chat/dialogue/messages/history",{con_uid:x}),{ready:!!x,refreshDeps:[x]}),{data:g,run:y}=(0,i.Z)(async()=>await (0,w.Tk)("/v1/chat/db/list"),{ready:!!m&&!!["chat_with_db_execute","chat_with_db_qa"].includes(m)}),{data:b}=(0,i.Z)(async()=>await (0,w.Tk)("/v1/chat/db/support/type"),{ready:!!m&&!!["chat_with_db_execute","chat_with_db_qa"].includes(m)}),{history:S,handleChatSubmit:P}=F({queryAgentURL:"/v1/chat/completions",queryBody:{conv_uid:x,chat_mode:m||"chat_normal"},initHistory:null==p?void 0:p.data,runHistoryList:j}),{data:k,run:C}=(0,i.Z)(async()=>await (0,w.Kw)("/v1/chat/mode/params/list?chat_mode=".concat(m)),{ready:!!m,refreshDeps:[x,m]});(0,n.useEffect)(()=>{try{var e;let l=null==S?void 0:null===(e=S[S.length-1])||void 0===e?void 0:e.context,a=JSON.parse(l);t((null==a?void 0:a.template_name)==="report"?null==a?void 0:a.charts:void 0)}catch(e){t(void 0)}},[S]);let E=(0,n.useMemo)(()=>{if(l){let e=[],t=null==l?void 0:l.filter(e=>"IndicatorValue"===e.chart_type);t.length>0&&e.push({charts:t,type:"IndicatorValue"});let a=null==l?void 0:l.filter(e=>"IndicatorValue"!==e.chart_type),n=a.length,s=0;return[[0],[1],[2],[1,2],[1,3],[2,1,2],[2,1,3],[3,1,3],[3,2,3]][n].forEach(l=>{if(l>0){let t=a.slice(s,s+l);s+=l,e.push({charts:t})}}),e}},[l]);return(0,a.jsxs)(B.Z,{container:!0,spacing:2,className:"h-full overflow-auto",sx:{flexGrow:1},children:[l&&(0,a.jsx)(B.Z,{xs:8,className:"max-h-full",children:(0,a.jsx)("div",{className:"flex flex-col gap-3 h-full",children:null==E?void 0:E.map((e,l)=>(0,a.jsx)("div",{className:"".concat((null==e?void 0:e.type)!=="IndicatorValue"?"flex gap-3":""),children:e.charts.map(e=>"IndicatorValue"===e.chart_type?(0,a.jsx)("div",{className:"flex flex-row gap-3",children:e.values.map(e=>(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(_.Z,{sx:{background:"transparent"},children:(0,a.jsxs)(N.Z,{className:"justify-around",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:e.name}),(0,a.jsx)(d.ZP,{children:e.value})]})})},e.name))},e.chart_uid):"LineChart"===e.chart_type?(0,a.jsx)(ef,{chart:e},e.chart_uid):"BarChart"===e.chart_type?(0,a.jsx)(ep,{chart:e},e.chart_uid):"Table"===e.chart_type?(0,a.jsx)(ej,{chart:e},e.chart_uid):void 0)},"chart_row_".concat(l)))})}),!l&&"chat_dashboard"===m&&(0,a.jsx)(B.Z,{xs:8,className:"max-h-full p-6",children:(0,a.jsx)("div",{className:"flex flex-col gap-3 h-full",children:(0,a.jsxs)(B.Z,{container:!0,spacing:2,sx:{flexGrow:1},children:[(0,a.jsx)(B.Z,{xs:8,children:(0,a.jsx)(v.Z,{className:"h-full w-full",sx:{display:"flex",gap:2},children:(0,a.jsx)(eg,{})})}),(0,a.jsx)(B.Z,{xs:4,children:(0,a.jsx)(eg,{})}),(0,a.jsx)(B.Z,{xs:4,children:(0,a.jsx)(eg,{})}),(0,a.jsx)(B.Z,{xs:8,children:(0,a.jsx)(eg,{})})]})})}),(0,a.jsx)(B.Z,{xs:"chat_dashboard"===m?4:12,className:"h-full max-h-full",children:(0,a.jsx)("div",{className:"h-full",style:{boxShadow:"chat_dashboard"===m?"0px 0px 9px 0px #c1c0c080":"unset"},children:(0,a.jsx)(em,{clearIntialMessage:async()=>{await h()},dialogue:f,dbList:null==g?void 0:g.data,runDbList:y,onRefreshHistory:j,supportTypes:null==b?void 0:b.data,messages:S||[],onSubmit:P,paramsList:null==k?void 0:k.data,runParamsList:C,setChartsData:t})})})]})},eb=t(32093),ew=t(97237);function eZ(){let{isContract:e,setIsContract:l}=(0,s.Cg)();return(0,a.jsxs)("div",{className:"relative w-56 h-10 mx-auto p-2 flex justify-center items-center bg-[#ece9e0] rounded-3xl model-tab dark:text-violet-600 z-10 ".concat(e?"editor-tab":""),children:[(0,a.jsxs)("div",{className:"z-10 w-[50%] text-center cursor-pointer",onClick:()=>{l(!1)},children:[(0,a.jsx)("span",{children:"Preview"}),(0,a.jsx)(ew.Z,{className:"ml-1"})]}),(0,a.jsxs)("div",{className:"z-10 w-[50%] text-center cursor-pointer",onClick:()=>{l(!0)},children:[(0,a.jsx)("span",{children:"Editor"}),(0,a.jsx)(eb.Z,{className:"ml-1"})]})]})}t(95389);var e_=()=>{let{isContract:e,setIsContract:l,setIsMenuExpand:t}=(0,s.Cg)(),i=(0,Z.useSearchParams)(),r=i.get("scene"),o=i.get("id"),d=r&&["chat_with_db_execute","chat_dashboard"].includes(r);return(0,n.useEffect)(()=>{t("chat_dashboard"!==r),o&&r&&l(!1)},[o,r,t,l]),(0,a.jsxs)(a.Fragment,{children:[d&&(0,a.jsx)("div",{className:"leading-[3rem] text-right pr-3 h-12 flex justify-center",children:(0,a.jsx)("div",{className:"flex items-center cursor-pointer",children:(0,a.jsx)(eZ,{})})}),e?(0,a.jsx)(R,{}):(0,a.jsx)(ey,{})]})}},57931:function(e,l,t){"use strict";t.d(l,{ZP:function(){return c},Cg:function(){return o}});var a=t(9268),n=t(11196),s=t(89749),i=t(86006),r=t(56008);let[o,d]=function(){let e=i.createContext(void 0);return[function(){let l=i.useContext(e);if(void 0===l)throw Error("useCtx must be inside a Provider with a value");return l},e.Provider]}();var c=e=>{let{children:l}=e,t=(0,r.useSearchParams)(),o=t.get("scene"),[c,u]=i.useState(!1),[h,v]=i.useState("chat_dashboard"!==o),{run:x,data:m,refresh:f}=(0,n.Z)(async()=>await (0,s.Tk)("/v1/chat/dialogue/list"),{manual:!0});return(0,a.jsx)(d,{value:{isContract:c,isMenuExpand:h,dialogueList:m,setIsContract:u,setIsMenuExpand:v,queryDialogueList:x,refreshDialogList:f},children:l})}},53534:function(e,l,t){"use strict";var a=t(24214),n=t(52040);let s=a.Z.create({baseURL:n.env.API_BASE_URL});s.defaults.timeout=1e4,s.interceptors.response.use(e=>e.data,e=>Promise.reject(e)),l.Z=s},89749:function(e,l,t){"use strict";t.d(l,{Ej:function(){return u},Kw:function(){return d},PR:function(){return c},Tk:function(){return o}});var a=t(21628),n=t(53534),s=t(84835);let i={"content-type":"application/json"},r=e=>{if(!(0,s.isPlainObject)(e))return JSON.stringify(e);let l={...e};for(let e in l){let t=l[e];"string"==typeof t&&(l[e]=t.trim())}return JSON.stringify(l)},o=(e,l)=>{if(l){let t=Object.keys(l).filter(e=>void 0!==l[e]&&""!==l[e]).map(e=>"".concat(e,"=").concat(l[e])).join("&");t&&(e+="?".concat(t))}return n.Z.get("/api"+e,{headers:i}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})},d=(e,l)=>{let t=r(l);return n.Z.post("/api"+e,{body:t,headers:i}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})},c=(e,l)=>n.Z.post(e,l,{headers:i}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)}),u=(e,l)=>n.Z.post(e,l).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})},95389:function(){}},function(e){e.O(0,[180,757,282,355,932,358,649,191,230,715,569,196,86,919,579,537,767,341,116,959,554,253,769,744],function(){return e(e.s=86066)}),_N_E=e.O()}]);